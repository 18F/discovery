{% load staticfiles %}
<!doctype HTML>
<html>
    
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width-device-width, initial-scale=1.0">
        
        <title>Mirage</title>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>

        <script type="text/javascript" src="{% static "mirage_site/js/jquery-2.1.1.min.js" %}"></script>
        <script type="text/javascript" src="{% static "mirage_site/js/mirage.js" %}"></script>
        <script type="text/javascript" src="{% static "mirage_site/js/select2.min.js" %}"></script>
        <script type="text/javascript" src="{% static "mirage_site/js/history.js/scripts/bundled/html4+html5/jquery.history.js" %}"></script>


        <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css">
        <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/base-min.css">
        <link rel="stylesheet" href="{% static "mirage_site/css/select2.css" %}" />


        <!--[if lte IE 8]>
            <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/grids-responsive-old-ie-min.css">
        <![endif]-->

        <!--
            <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/grids-responsive-min.css">[if gt IE 8]><!-->

         <!--[if gt IE 8]><!-->
            <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/grids-core-min.css">
        <!--<![endif]-->
        
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="{% static "mirage_site/css/layouts/blog-old-ie.css" %}">
        <![endif]-->
        
        <!--[if gt IE 8]><!-->
            <link rel="stylesheet" href="{% static "mirage_site/css/layouts/blog.css" %}">
        <!--<![endif]-->


        <!--[if lt IE 9]>
            <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.js"></script>
        <![endif]-->

        <script>
        $(document).ready(function() { 
        $('#naics-code').select2({dropdownAutoWidth : true});
        });
        </script>

    </head>
    <body>

        <div id="container">

            <div id="header">
                <div id="page_title">
                    <span class="oasis_title">OASIS Market Research Tool</span>
                    <span class="oasis_subtitle">find vendors by NAICS with the set-asides you need</span>
                </div><!--end page_title<!-->

                <div id="search">
                    <form id="naics-search" class="pure-form">
                        <select id="naics-code">
                            <option>Select an option</option>
                        </select>
                    </form>
                </div><!--end search<!-->
            </div><!--end header<!-->

            <div id="filter_container">
                <h3 class="filter_title">Filters</h3>
                <div id="filter" class="filterbox">
                    <form id="setaside-filters" class="pure-form pure-form-stacked">
                        <fieldset>
                            <label class="pure-checkbox" for="vet"><input type="checkbox" id="vet" name="vet" value="A5" />Veteran Owned</label>
                            <label class="pure-checkbox labeltest" for="smalldis"><input type="checkbox" id="smalldis" name="smalldis" value="27" />Small, Disadvantaged Business</label>
                            <label class="pure-checkbox" for="disvet"><input type="checkbox" id="disvet" name="disvet" value="QF" />Service Disabled Veteran Owned</label>
                            <label class="pure-checkbox" for="woman"><input type="checkbox" id="woman" name="woman" value="A2" />Woman Owned</label>
                            <label class="pure-checkbox" for="hub"><input type="checkbox" id="hub" name="hub" value="XX" />HUBZone</label>
                            <label class="pure-checkbox" for="8a"><input type="checkbox" id="8a" name="8a" value="A6" />8(a)</label>
                        </fieldset>
                    </form>
                </div><!--end filterbox<!-->
            </div><!--end filter<!-->


            <div id="main_container">

                <div id="tabs_container">

                    <div id="select_vehicle">
                        <a class="select_vehicle" href="#" title="OASIS SB">
                          OASIS SB
                        </a>
                    </div><!--end select_vehicle<!-->

                </div><!--end tabs_container<!-->

                <div id="breadcrumbs">
                    <ul id="crumbs">
                    {% block crumbs %}
                    {% endblock %}
                    </ul>
                </div><!--end breadcrumbs<!-->

                <div id="results_sam_container">

                    <div id="number_of_results">
                        <span class="matching_your_search"></span>
                    </div><!--end number_of_results<!-->

                    <div id="sam_last_updated">
                        <span id="sam_load" class="sam_style"></span>
                    </div><!--end sam_last_updated<!-->

                <!--end results_sam_container<!-->

            </div><!--end main_container<!-->



                <!--CUSTOM PAGE CONTENT HERE!-->            

                    <div id="custom_page_content">
                        {% block content %}
                        {% endblock %}
                    </div><!--end custom_page_content<!-->

                <!--END CUSTOM PAGE CONTENT!-->  

        </div><!--end container<!-->


      






        <style>
        /*  #naics-code { width: 100%; }
          #search { margin-left: 0; }
        */
        </style>

        <script type="text/javascript">

            var get_code = function () {
                return $('#naics-code').val();
            };
           
            var get_setasides = function(){
                var setasides = [];
                $("form#setaside-filters input:checked").each( function(index) {
                    setasides.push($(this).val());
                });

                return setasides;
            }

            var load_content = function(results) {
            
                var container = $("#custom_page_content");
                var data = results['results'];
                var total = results['num_results'];

                //load SAM update date
                var date_obj = new Date(results['sam_load']);
                $("#sam_load").text("SAM data updated: " + (date_obj.getMonth() + 1) + '/' + date_obj.getDate() + '/' + date_obj.getFullYear().toString().substring(2));

                //load title data
                $("#number_of_results span").text(total.toString() + " vendors in " + data.length.toString()  + " pool(s) match your search");

                //load vendor data
                for (var e in data) {
                    var obj = data[e];
                    
                    var div = $(document.createElement('div'));
                    div.addClass("column post-header");
                    div.append( $(document.createElement('h2')).addClass("pool_title").text("Pool " + obj['number']));
                    div.append( $(document.createElement('p')).addClass("post-meta number_of_vendors_in_pool").text(obj['vendors'].length.toString() + ' vendors'));

                    for (var v in obj['vendors']){
                        div.append( $(document.createElement('p')).addClass("vendor_names").text(obj['vendors'][v]['name']) );
                    }
                    container.append(div);
                }
            }

            var clear_content = function(){
                $("#custom_page_content").find("div.column").remove();
            };

            var refresh_data = function(event) {
                var code = get_code();
                var setasides = get_setasides(); 
                var url = "/api/vendors/"
                var query_data = {'group': 'pool'}
            
                if (code != 'null' && code != null) {
                    query_data["naics"] = code;
                }
                if (setasides.length > 0) {
                    query_data["setasides"] = setasides.join();
                }
                
                $.getJSON(url, query_data,  function(data){
                    clear_content();
                    load_content(data);
                });

                return false;
            }

            var build_query_string = function(event) {
                var qs = "?";
                if (get_code() != 'Select an option') {
                    qs += "naics-code=" + get_code() + "&";
                }
                qs += "setasides=" + get_setasides();
                console.log(qs);
                History.pushState(null, null, qs);
                return refresh_data(event);
            }

            $("#naics-code").change(build_query_string);
            $("#setaside-filters").change(build_query_string);

            
        </script>

    </body>

</html>
